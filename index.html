<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
</head>
<body>
  <section id="plotArea">
    <table>
      <tr><td colspan="2">Mouse position in canvas</td>
          <td>(<span id="xCanvasCoord"></span>,<span id="yCanvasCoord"></span>)</td></tr>
      <tr><td colspan="2">Mouse position in complex plane</td>
          <td>(<span id="xComplexCoord"></span>,<span id="yComplexCoord"></span>)</td></tr>
      <tr><td>Maximum iterations</td>
          <td><input id="max_iters" type="range" min="100" max="10000" step="50" value="1000"></td>
          <td><input id="max_iters_value" type="input"></td></tr>
      <tr><td>Zoom</td>
          <td><input id="zoom" type="range" min="100" max="10000" step="50" value="200"></td>
          <td><input id="zoom_value" type="input"></td></tr>
      <tr><td>X origin</td>
        <td><input id="origin_x" type="range" min="-2" max="2" step="0.01" value="-0.5"></td>
        <td><input id="origin_x_value" type="input"></td></tr>
    <tr><td>Y origin</td>
        <td><input id="origin_y" type="range" min="-2" max="2" step="0.01" value="0"></td>
        <td><input id="origin_y_value" type="input"></td></tr>
    <tr><td>WASM Execution Time</td>
        <td style="text-align: right;"><span id="wasm_exec_time"></span></td>
        <td>ms</td></tr>
    </table>
    <canvas id="mandelImage" width="800" height="450" style="border: 1px solid black"></canvas>
  </section>
<script type="module">
import {
  showHostFns,
  testWasm,
} from "./src/js/testUtils.js"

import {
  WasmModule,
  instantiateWasmModuleSequence
} from "./src/js/wasmUtils.js"

// import { complexTestMap } from "./src/complex/tests.js"
// import { mandelTestMap }  from "./src/mandel/tests.js"
// import { colourTestMap }  from "./src/render/tests.js"

const TEST_MODE   = false
const SHOW_DETAIL = false

const WASM_PAGE_SIZE = 65536

const DEFAULT_PPU       = 8300             // Default pixels per unit (controls zoom level)
const DEFAULT_ORIGIN_X  = -0.65            // Centre X canvas pixel in the Mandelbrot coordinate space
const DEFAULT_ORIGIN_Y  = -0.35            // Centre Y canvas pixel in the Mandelbort coordinate space
const DEFAULT_MAX_ITERS = 650              // Default number of iterations for the escape time algorithm

function $id(elId) { return document.getElementById(elId) }

const toMilliTenths = val => Math.round(val * 10000) / 10000

const mCanvas     = $id('mandelImage')
const mContext    = mCanvas.getContext('2d')
const mImage      = mContext.createImageData(mCanvas.width, mCanvas.height)
const mImageSize  = mCanvas.width * mCanvas.height * 4
const mImagePages = Math.ceil(mImageSize / WASM_PAGE_SIZE)

// Arbitrarily allocate 4 pages for the colour palette.
// This allows for images to be calculated with a maximum iteration value up to 32768
const palettePages = 4

// Translate the mouse X or Y canvas position to the corresponding X or Y coordinate in the complex plain
const mouseAxisToCoordAxis = (cnvsDim, ppu, origin) => mousePos => origin + ((mousePos - (cnvsDim / 2)) / ppu)

window.mandelXToCoordXFn = mouseAxisToCoordAxis(mCanvas.width,  DEFAULT_PPU, DEFAULT_ORIGIN_X)
window.mandelYToCoordYFn = mouseAxisToCoordAxis(mCanvas.height, DEFAULT_PPU, DEFAULT_ORIGIN_Y)

const offsetToClampedPos = (offset, dim, offsetDim) =>
  (pos => pos < 0 ? 0 : pos > dim ? dim : pos)
  (offset - ((offsetDim - dim) / 2))

const mousePositionOnCanvas = e => ({
  "x_pos" : offsetToClampedPos(e.offsetX, e.target.width,  e.target.offsetWidth),
  "y_pos" : offsetToClampedPos(e.offsetY, e.target.height, e.target.offsetHeight)
})

// Track mouse pointer position in the Mandelbrot set
const mouseTrack =
  evt => {
    let canvasCoords = mousePositionOnCanvas(evt)

    $id('xCanvasCoord').innerHTML = canvasCoords.x_pos
    $id('yCanvasCoord').innerHTML = canvasCoords.y_pos
    $id('xComplexCoord').innerHTML = window.mandelXToCoordXFn(canvasCoords.x_pos)
    $id('yComplexCoord').innerHTML = window.mandelYToCoordYFn(canvasCoords.y_pos) * -1
  }

mCanvas.addEventListener('mousemove', mouseTrack, false)

const drawMandelbrotSet =
  (w, h, x, y, z, i) => {
    let then = window.performance.now()
    window.mandel_plot(w, h, x, y, z, i)
    $id("wasm_exec_time").innerHTML = `${toMilliTenths(window.performance.now() - then)}`

    mImage.data.set(wasmMemBuff.slice(0, w * h * 4))
    mContext.putImageData(mImage,0,0)
  }

// ---------------------------------------------------------------------------------------------------------------------
// These WASM modules must be instantiated in the order listed below due to the fact that later modules have import
// dependencies on earlier modules
const instantiationSequence = [
  // new WasmModule('./build/complex.wasm',       'cplx'),
  new WasmModule('./build/mandel.wasm',         'mandel'),
  new WasmModule('./build/colour_palette.wasm', 'colours'),
  new WasmModule('./build/canvas.wasm',         'canvas'),
]

const wasmMemory  = new WebAssembly.Memory({ initial : mImagePages + palettePages })
const wasmMemBuff = new Uint8ClampedArray(wasmMemory.buffer)

function update_img(evt) {
  switch(evt.target.id) {
    case "origin_x":
      document.getElementById('origin_x_value').value = evt.target.value

      drawMandelbrotSet(
        mCanvas.width,
        mCanvas.height,
        evt.target.value,
        $id('origin_y').value,
        $id('zoom').value,
        $id('max_iters').value,
      )
      break

    case "origin_y":
      document.getElementById('origin_y_value').value = evt.target.value

      drawMandelbrotSet(
        mCanvas.width,
        mCanvas.height,
        $id('origin_x').value,
        evt.target.value,
        $id('zoom').value,
        $id('max_iters').value,
      )
      break

    case "zoom":
      document.getElementById('zoom_value').value = evt.target.value

      drawMandelbrotSet(
        mCanvas.width,
        mCanvas.height,
        $id('origin_x').value,
        $id('origin_y').value,
        evt.target.value,
        $id('max_iters').value,
      )
      break

    case "max_iters":
      document.getElementById('max_iters_value').value = evt.target.value

      // Update the colour palette
      window.hsl_to_rgb(evt.target.value)

      drawMandelbrotSet(
        mCanvas.width,
        mCanvas.height,
        $id('origin_x').value,
        $id('origin_y').value,
        $id('zoom').value,
        evt.target.value,
      )
      break

    default:
  }
}

function resetUI() {
  let zoom_slider      = $id("zoom")
  let max_iters_slider = $id("max_iters")
  let origin_x_slider  = $id("origin_x")
  let origin_y_slider  = $id("origin_y")

  zoom_slider.addEventListener("input", update_img, false)
  max_iters_slider.addEventListener("input", update_img, false)
  origin_x_slider.addEventListener("input", update_img, false)
  origin_y_slider.addEventListener("input", update_img, false)

  $id('zoom').value = DEFAULT_PPU
  $id('zoom_value').value = DEFAULT_PPU

  $id('max_iters').value = DEFAULT_MAX_ITERS
  $id('max_iters_value').value = DEFAULT_MAX_ITERS

  $id('origin_x').value = DEFAULT_ORIGIN_X
  $id('origin_x_value').value = DEFAULT_ORIGIN_X

  $id('origin_y').value = DEFAULT_ORIGIN_Y
  $id('origin_y_value').value = DEFAULT_ORIGIN_Y
}

const importObject = {
  math : Math,
  js : {
    shared_mem : wasmMemory,
    img_offset : 0,
    palette_offset : mImagePages * WASM_PAGE_SIZE,
  }
}

instantiateWasmModuleSequence(instantiationSequence, importObject)
  .then(wasmModules => {
    // testWasm(TEST_MODE, wasmModules.cplx.instance, complexTestMap, SHOW_DETAIL)
    // testWasm(TEST_MODE, wasmModules.mandel.instance, mandelTestMap, SHOW_DETAIL)
    // testWasm(TEST_MODE, wasmModules.canvas.instance, colourTestMap, SHOW_DETAIL)
    // showHostFns(wasmModules.hostFunctions)

    window.mandel_plot = wasmModules.canvas.instance.exports.mandel_plot
    window.hsl_to_rgb  = wasmModules.colours.instance.exports.hsl_to_rgb

    resetUI()

    // Generate the colour palette
    window.hsl_to_rgb(DEFAULT_MAX_ITERS)

      // Draw the Mandelbrot set at default location and zoom level
    drawMandelbrotSet(
      mCanvas.width,
      mCanvas.height,
      DEFAULT_ORIGIN_X,
      DEFAULT_ORIGIN_Y,
      DEFAULT_PPU,
      DEFAULT_MAX_ITERS,
    )
  })
</script>
</body>
</html>
