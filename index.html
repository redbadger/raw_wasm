<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
</head>
<body>
<script type="module">
import {
  showHostFns,
  testWasm,
} from "./src/js/testUtils.js"

import { instantiateWasmModuleSequence } from "./src/js/wasmUtils.js"
import { complexTestMap } from "./src/complex/tests.js"

const TEST_MODE   = false
const SHOW_DETAIL = false

// -----------------------------------------------------------------------------
// Host functions required by the first WASM module to be instantiated.
// This object will be extended after each WASM module instantiation so that any
// functions exported from one module can (if necessary) be imported by some
// subsequent module
let hostFunctions = {
  math: {
    sin   : Math.sin,
    cos   : Math.cos,
    sinh  : Math.sinh,
    cosh  : Math.cosh,
    ln    : Math.log,
    atan2 : Math.atan2
  }
}

let wasmSequence = [
  { wasmSrc : './build/complex.wasm', libName : 'cplx',   wasmObj : null },
  { wasmSrc : './build/mandel.wasm',  libName : 'mandel', wasmObj : null }
]

// -----------------------------------------------------------------------------
async function start() {
  let wasmModules = await instantiateWasmModuleSequence(wasmSequence, hostFunctions)

  testWasm(TEST_MODE, wasmModules.cplx.wasmObj.instance, complexTestMap, SHOW_DETAIL)
  showHostFns(hostFunctions)

  console.log(`hostFunctions.mandel.test_add(3,0,4,0) = ${hostFunctions.mandel.test_add(3,0,4,0)}`)
}

  start()
</script>
</body>
